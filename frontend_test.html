<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayPal å‰ç«¯åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-online {
            background-color: #28a745;
        }
        .status-offline {
            background-color: #dc3545;
        }
        .status-unknown {
            background-color: #ffc107;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ PlayPal å‰ç«¯åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-container">
        <h2>API è¿æ¥çŠ¶æ€</h2>
        <div class="api-status">
            <span class="status-indicator" id="apiStatus"></span>
            <span id="apiStatusText">æ­£åœ¨æ£€æŸ¥ API è¿æ¥...</span>
        </div>
        
        <div class="test-section">
            <h3>ç”¨æˆ·è®¤è¯æµ‹è¯•</h3>
            <button onclick="testUserRegistration()">æµ‹è¯•ç”¨æˆ·æ³¨å†Œ</button>
            <button onclick="testUserLogin()">æµ‹è¯•ç”¨æˆ·ç™»å½•</button>
            <button onclick="testUserProfile()">æµ‹è¯•ç”¨æˆ·èµ„æ–™</button>
            <div id="authResults"></div>
        </div>
        
        <div class="test-section">
            <h3>çƒå±€åŠŸèƒ½æµ‹è¯•</h3>
            <button onclick="testMatchCreation()">æµ‹è¯•åˆ›å»ºçƒå±€</button>
            <button onclick="testMatchListing()">æµ‹è¯•çƒå±€åˆ—è¡¨</button>
            <button onclick="testMatchJoin()">æµ‹è¯•åŠ å…¥çƒå±€</button>
            <div id="matchResults"></div>
        </div>
        
        <div class="test-section">
            <h3>å®æ—¶åŠŸèƒ½æµ‹è¯•</h3>
            <button onclick="testRealtimeSubscription()">æµ‹è¯•å®æ—¶è®¢é˜…</button>
            <button onclick="testMessageSending()">æµ‹è¯•æ¶ˆæ¯å‘é€</button>
            <div id="realtimeResults"></div>
        </div>
        
        <div class="test-section">
            <h3>æ€§èƒ½æµ‹è¯•</h3>
            <button onclick="testApiPerformance()">æµ‹è¯• API æ€§èƒ½</button>
            <button onclick="testConcurrentRequests()">æµ‹è¯•å¹¶å‘è¯·æ±‚</button>
            <div id="performanceResults"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
        
        // Supabase é…ç½®
        const supabaseUrl = 'https://nanhthqbcmqxqlqazevm.supabase.co'
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hbmh0aHFiY21xeHFscWF6ZXZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNTQzNTQsImV4cCI6MjA3NjgzMDM1NH0.5UkguCPOX6xm9WqZRPFwcMVZS0Lxgc4mVm9vpzoaD1w'
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey)
        let currentUser = null
        let testMatchId = null
        
        // æ£€æŸ¥ API è¿æ¥çŠ¶æ€
        async function checkApiStatus() {
            const statusIndicator = document.getElementById('apiStatus')
            const statusText = document.getElementById('apiStatusText')
            
            try {
                const { data, error } = await supabase.auth.getSession()
                
                if (error) {
                    statusIndicator.className = 'status-indicator status-offline'
                    statusText.textContent = 'API è¿æ¥å¤±è´¥: ' + error.message
                } else {
                    statusIndicator.className = 'status-indicator status-online'
                    statusText.textContent = 'API è¿æ¥æ­£å¸¸ - Supabase æœåŠ¡åœ¨çº¿'
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator status-unknown'
                statusText.textContent = 'API è¿æ¥æ£€æŸ¥å¼‚å¸¸: ' + error.message
            }
        }
        
        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showResult(containerId, message, isSuccess = true) {
            const container = document.getElementById(containerId)
            const resultDiv = document.createElement('div')
            resultDiv.className = `test-result ${isSuccess ? 'success' : 'error'}`
            resultDiv.innerHTML = `
                <strong>${new Date().toLocaleTimeString()}</strong><br>
                ${message}
            `
            container.appendChild(resultDiv)
            container.scrollTop = container.scrollHeight
        }
        
        // æµ‹è¯•ç”¨æˆ·æ³¨å†Œ
        async function testUserRegistration() {
            const testEmail = `test_${Date.now()}@playpal.com`
            
            showResult('authResults', 'å¼€å§‹æµ‹è¯•ç”¨æˆ·æ³¨å†Œ...', true)
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: testEmail,
                    password: 'Test123456!',
                    options: {
                        data: {
                            nickname: 'æµ‹è¯•ç”¨æˆ·'
                        }
                    }
                })
                
                if (error) {
                    showResult('authResults', `æ³¨å†Œå¤±è´¥: ${error.message}`, false)
                } else {
                    showResult('authResults', `æ³¨å†ŒæˆåŠŸ! ç”¨æˆ·ID: ${data.user?.id || 'N/A'}`, true)
                    currentUser = data.user
                }
            } catch (error) {
                showResult('authResults', `æ³¨å†Œå¼‚å¸¸: ${error.message}`, false)
            }
        }
        
        // æµ‹è¯•ç”¨æˆ·ç™»å½•
        async function testUserLogin() {
            showResult('authResults', 'å¼€å§‹æµ‹è¯•ç”¨æˆ·ç™»å½•...', true)
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'test@playpal.com',
                    password: 'Test123456!'
                })
                
                if (error) {
                    showResult('authResults', `ç™»å½•å¤±è´¥: ${error.message}`, false)
                } else {
                    showResult('authResults', `ç™»å½•æˆåŠŸ! æ¬¢è¿ ${data.user?.email}`, true)
                    currentUser = data.user
                }
            } catch (error) {
                showResult('authResults', `ç™»å½•å¼‚å¸¸: ${error.message}`, false)
            }
        }
        
        // æµ‹è¯•ç”¨æˆ·èµ„æ–™
        async function testUserProfile() {
            if (!currentUser) {
                showResult('authResults', 'è¯·å…ˆç™»å½•ç”¨æˆ·', false)
                return
            }
            
            showResult('authResults', 'å¼€å§‹æµ‹è¯•ç”¨æˆ·èµ„æ–™...', true)
            
            try {
                // åˆ›å»ºç”¨æˆ·èµ„æ–™
                const { error } = await supabase
                    .from('profiles')
                    .upsert([{
                        id: currentUser.id,
                        email: currentUser.email,
                        nickname: 'æµ‹è¯•ç”¨æˆ·',
                        pickleball_level: '3.0'
                    }])
                
                if (error) {
                    showResult('authResults', `åˆ›å»ºèµ„æ–™å¤±è´¥: ${error.message}`, false)
                } else {
                    showResult('authResults', 'ç”¨æˆ·èµ„æ–™åˆ›å»ºæˆåŠŸ!', true)
                }
            } catch (error) {
                showResult('authResults', `èµ„æ–™æ“ä½œå¼‚å¸¸: ${error.message}`, false)
            }
        }
        
        // æµ‹è¯•åˆ›å»ºçƒå±€
        async function testMatchCreation() {
            if (!currentUser) {
                showResult('matchResults', 'è¯·å…ˆç™»å½•ç”¨æˆ·', false)
                return
            }
            
            showResult('matchResults', 'å¼€å§‹æµ‹è¯•åˆ›å»ºçƒå±€...', true)
            
            try {
                const matchData = {
                    title: 'å‰ç«¯æµ‹è¯•çƒå±€',
                    sport: 'åŒ¹å…‹çƒ',
                    time: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                    location: 'æµ‹è¯•åœºåœ°',
                    max_players: 4,
                    description: 'å‰ç«¯åŠŸèƒ½æµ‹è¯•ç”¨çƒå±€',
                    creator_id: currentUser.id
                }
                
                const { data, error } = await supabase
                    .from('matches')
                    .insert([matchData])
                    .select()
                
                if (error) {
                    showResult('matchResults', `åˆ›å»ºçƒå±€å¤±è´¥: ${error.message}`, false)
                } else {
                    testMatchId = data[0].id
                    showResult('matchResults', `çƒå±€åˆ›å»ºæˆåŠŸ! ID: ${testMatchId}`, true)
                }
            } catch (error) {
                showResult('matchResults', `åˆ›å»ºçƒå±€å¼‚å¸¸: ${error.message}`, false)
            }
        }
        
        // æµ‹è¯•çƒå±€åˆ—è¡¨
        async function testMatchListing() {
            showResult('matchResults', 'å¼€å§‹æµ‹è¯•çƒå±€åˆ—è¡¨...', true)
            
            try {
                const { data, error } = await supabase
                    .from('matches')
                    .select(`
                        *,
                        creator:profiles!matches_creator_id_fkey(nickname, avatar),
                        participants:match_participants(participant:profiles!match_participants_participant_id_fkey(nickname))
                    `)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false })
                    .limit(5)
                
                if (error) {
                    showResult('matchResults', `è·å–çƒå±€åˆ—è¡¨å¤±è´¥: ${error.message}`, false)
                } else {
                    showResult('matchResults', `è·å–æˆåŠŸ! å…± ${data.length} ä¸ªçƒå±€`, true)
                }
            } catch (error) {
                showResult('matchResults', `è·å–çƒå±€åˆ—è¡¨å¼‚å¸¸: ${error.message}`, false)
            }
        }
        
        // æµ‹è¯•åŠ å…¥çƒå±€
        async function testMatchJoin() {
            if (!currentUser || !testMatchId) {
                showResult('matchResults', 'è¯·å…ˆåˆ›å»ºæµ‹è¯•çƒå±€', false)
                return
            }
            
            showResult('matchResults', 'å¼€å§‹æµ‹è¯•åŠ å…¥çƒå±€...', true)
            
            try {
                const { error } = await supabase
                    .from('match_participants')
                    .insert([{
                        match_id: testMatchId,
                        participant_id: currentUser.id
                    }])
                
                if (error) {
                    showResult('matchResults', `åŠ å…¥çƒå±€å¤±è´¥: ${error.message}`, false)
                } else {
                    showResult('matchResults', 'æˆåŠŸåŠ å…¥çƒå±€!', true)
                }
            } catch (error) {
                showResult('matchResults', `åŠ å…¥çƒå±€å¼‚å¸¸: ${error.message}`, false)
            }
        }
        
        // æµ‹è¯•å®æ—¶è®¢é˜…
        async function testRealtimeSubscription() {
            showResult('realtimeResults', 'å¼€å§‹æµ‹è¯•å®æ—¶è®¢é˜…...', true)
            
            try {
                const subscription = supabase
                    .channel('frontend-test')
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'matches' },
                        (payload) => {
                            showResult('realtimeResults', `å®æ—¶è®¢é˜…æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(payload)}`, true)
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            showResult('realtimeResults', 'å®æ—¶è®¢é˜…å·²å»ºç«‹!', true)
                        }
                    })
                
                // 5ç§’åå–æ¶ˆè®¢é˜…
                setTimeout(() => {
                    subscription.unsubscribe()
                    showResult('realtimeResults', 'å®æ—¶è®¢é˜…å·²å–æ¶ˆ', true)
                }, 5000)
                
            } catch (error) {
                showResult('realtimeResults', `å®æ—¶è®¢é˜…å¼‚å¸¸: ${error.message}`, false)
            }
        }
        
        // æµ‹è¯•æ¶ˆæ¯å‘é€
        async function testMessageSending() {
            if (!currentUser || !testMatchId) {
                showResult('realtimeResults', 'è¯·å…ˆåˆ›å»ºæµ‹è¯•çƒå±€', false)
                return
            }
            
            showResult('realtimeResults', 'å¼€å§‹æµ‹è¯•æ¶ˆæ¯å‘é€...', true)
            
            try {
                const { error } = await supabase
                    .from('messages')
                    .insert([{
                        match_id: testMatchId,
                        sender_id: currentUser.id,
                        content: 'å‰ç«¯æµ‹è¯•æ¶ˆæ¯',
                        message_type: 'text'
                    }])
                
                if (error) {
                    showResult('realtimeResults', `å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`, false)
                } else {
                    showResult('realtimeResults', 'æ¶ˆæ¯å‘é€æˆåŠŸ!', true)
                }
            } catch (error) {
                showResult('realtimeResults', `å‘é€æ¶ˆæ¯å¼‚å¸¸: ${error.message}`, false)
            }
        }
        
        // æµ‹è¯• API æ€§èƒ½
        async function testApiPerformance() {
            showResult('performanceResults', 'å¼€å§‹æµ‹è¯• API æ€§èƒ½...', true)
            
            const startTime = performance.now()
            
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, nickname')
                    .limit(10)
                
                const endTime = performance.now()
                const duration = Math.round(endTime - startTime)
                
                if (error) {
                    showResult('performanceResults', `API è°ƒç”¨å¤±è´¥: ${error.message}`, false)
                } else {
                    showResult('performanceResults', `API è°ƒç”¨æˆåŠŸ! è€—æ—¶: ${duration}ms`, true)
                }
            } catch (error) {
                showResult('performanceResults', `API æ€§èƒ½æµ‹è¯•å¼‚å¸¸: ${error.message}`, false)
            }
        }
        
        // æµ‹è¯•å¹¶å‘è¯·æ±‚
        async function testConcurrentRequests() {
            showResult('performanceResults', 'å¼€å§‹æµ‹è¯•å¹¶å‘è¯·æ±‚...', true)
            
            try {
                const requests = Array.from({ length: 5 }, (_, i) => 
                    supabase.from('profiles').select('id').limit(1)
                )
                
                const startTime = performance.now()
                const results = await Promise.all(requests)
                const endTime = performance.now()
                const duration = Math.round(endTime - startTime)
                
                const successful = results.filter(r => !r.error).length
                
                showResult('performanceResults', 
                    `å¹¶å‘æµ‹è¯•å®Œæˆ! æˆåŠŸ: ${successful}/5, æ€»è€—æ—¶: ${duration}ms`, 
                    successful === 5
                )
                
            } catch (error) {
                showResult('performanceResults', `å¹¶å‘æµ‹è¯•å¼‚å¸¸: ${error.message}`, false)
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ API çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            checkApiStatus()
        })
    </script>
</body>
</html>